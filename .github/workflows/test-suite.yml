name: test-suite

on:
  push:
    branches:
      - stable
      - staging
      - trying
      - 'pr/*'
  pull_request:
env:
  # Deny warnings in CI
  # Disable debug info (see https://github.com/sigp/lighthouse/issues/4005)
  RUSTFLAGS: "-D warnings -C debuginfo=0"
  # The Nightly version used for cargo-udeps, might need updating from time to time.
  PINNED_NIGHTLY: nightly-2022-12-15
  # Prevent Github API rate limiting.
  LIGHTHOUSE_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  cargo-fmt:
    name: cargo-fmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Get latest version of stable Rust
        run: rustup update stable
      - name: Check formatting with cargo fmt
        run: make cargo-fmt
  release-tests-ubuntu:
    name: release-tests-ubuntu
    runs-on: [self-hosted, linux, large]
    needs: cargo-fmt
    steps:
      - uses: actions/checkout@v3
      - name: Run tests in release
        run: make test-release
